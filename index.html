<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Typing Master: Particle & Music Edition</title>
    <style>
        :root { --main-color: #58a6ff; --bg-color: #0d1117; }
        body {
            background: var(--bg-color); color: #c9d1d9;
            font-family: 'Segoe UI', sans-serif;
            margin: 0; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; transition: background 0.2s;
        }
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 10; }
        .container { text-align: center; width: 100%; z-index: 5; }
        #word-jp { font-size: 5rem; margin: 0; color: var(--main-color); }
        .typing-wrapper {
            position: relative; font-size: 3.5rem; height: 4.5rem;
            margin-top: 10px; letter-spacing: 5px; font-family: monospace;
        }
        #ghost-word { position: absolute; width: 100%; left: 0; color: #30363d; z-index: 1; }
        #display-romaji { position: absolute; width: 100%; left: 0; z-index: 2; }
        .typed { color: #3fb950; text-shadow: 0 0 10px rgba(63,185,80,0.5); }
        .stats { margin-top: 40px; font-size: 1.2rem; display: flex; justify-content: center; gap: 30px; }
        .mistake-flash { background: #4a0000 !important; }
        #ranking-container {
            margin-top: 20px; background: rgba(255, 255, 255, 0.05);
            padding: 15px; border-radius: 10px; display: none;
        }
        .rank-item { color: #f1c40f; margin: 5px 0; }
    </style>
</head>
<body>
    <canvas id="particleCanvas"></canvas>

    <div class="container" id="game-body">
        <div id="combo-text" style="font-size: 2rem; font-weight: bold; color: #f0883e; visibility: hidden; height: 40px;">
            COMBO x<span id="combo-count">0</span>
        </div>
        <div style="color:#f1c40f; font-weight:bold;">LEVEL <span id="level-display">1</span></div>
        <h1 id="word-jp">LOADING...</h1>
        <div class="typing-wrapper">
            <div id="ghost-word"></div>
            <div id="display-romaji">Wait...</div>
        </div>
        <div class="stats">
            <div>SCORE: <span id="score">0</span></div>
            <div>ACC: <span id="accuracy">100</span>%</div>
            <div>TIME: <span id="timer">20.0</span>s</div>
        </div>
        <div id="ranking-container">
            <h3>üèÜ BEST SCORES</h3>
            <div id="ranking-list"></div>
            <p style="font-size: 0.8rem; color: #888;">‰Ωï„Åã„Ç≠„Éº„ÇíÊäº„Åó„Å¶„É™„Éà„É©„Ç§</p>
        </div>
    </div>

    <script>
        let wordBanks = {};
        let score = 0, timeLeft = 20, isPlaying = false;
        let currentRomaji = "", charIndex = 0, combo = 0;
        let totalKeys = 0, correctKeys = 0, level = 1, wordsTyped = 0;
        let timerInterval;

        const canvas = document.getElementById('particleCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÁÆ°ÁêÜ
        let particles = [];
        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                this.size = Math.random() * 5 + 2;
                this.speedX = (Math.random() - 0.5) * 10;
                this.speedY = (Math.random() - 0.5) * 10;
                this.color = color;
                this.alpha = 1;
            }
            update() {
                this.x += this.speedX; this.y += this.speedY;
                this.alpha -= 0.02;
            }
            draw() {
                ctx.globalAlpha = this.alpha;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function createParticles(color) {
            for (let i = 0; i < 20; i++) {
                particles.push(new Particle(window.innerWidth / 2, window.innerHeight / 2, color));
            }
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles = particles.filter(p => p.alpha > 0);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animate);
        }
        animate();

        // „Ç™„Éº„Éá„Ç£„Ç™Ë®≠ÂÆö (BGM & ÂäπÊûúÈü≥)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playNote(freq, type, duration, vol) {
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.type = type; o.frequency.value = freq;
            g.gain.setValueAtTime(vol, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + duration);
        }

        // BGMÁîüÊàê („Ç∑„É≥„Éó„É´„Å™„É´„Éº„Éó)
        function startBGM() {
            let notes = [261.63, 293.66, 329.63, 349.23]; // C, D, E, F
            let i = 0;
            setInterval(() => {
                if (isPlaying) {
                    playNote(notes[i % notes.length] * 0.5, 'triangle', 0.5, 0.02);
                    i++;
                }
            }, 500);
        }

        async function loadWords() {
            try {
                const response = await fetch('words.json');
                wordBanks = await response.json();
                document.getElementById('word-jp').innerText = "READY?";
                document.getElementById('display-romaji').innerText = "Any key to Start";
            } catch (e) { document.getElementById('word-jp').innerText = "FETCH ERROR"; }
        }

        window.addEventListener('keydown', (e) => {
            if (e.key === "Shift") return;
            if (!isPlaying && timeLeft <= 0) { location.reload(); return; }
            if (!isPlaying && wordBanks["1"]) {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                isPlaying = true;
                startBGM();
                timerInterval = setInterval(() => {
                    timeLeft -= 0.1;
                    document.getElementById('timer').innerText = Math.max(0, timeLeft).toFixed(1);
                    if (timeLeft <= 0) endGame();
                }, 100);
                nextWord();
                return;
            }
            if (!isPlaying) return;

            totalKeys++;
            if (e.key === currentRomaji[charIndex]) {
                correctKeys++;
                charIndex++;
                playNote(400 + (combo * 15), 'sine', 0.1, 0.1);
                document.getElementById('display-romaji').innerHTML = `<span class="typed">${currentRomaji.substring(0, charIndex)}</span>`;
                if (charIndex === currentRomaji.length) {
                    combo++;
                    score += (10 * combo * level);
                    timeLeft += Math.max(0.4, 1.5 - (level * 0.2));
                    createParticles('#3fb950'); // Ê≠£Ëß£„Éë„Éº„ÉÜ„Ç£„ÇØ„É´
                    wordsTyped++;
                    if (wordsTyped >= 5) { level++; wordsTyped = 0; }
                    nextWord();
                }
            } else {
                combo = 0;
                document.body.classList.add('mistake-flash');
                setTimeout(() => document.body.classList.remove('mistake-flash'), 150);
                playNote(100, 'sawtooth', 0.2, 0.05);
            }
            document.getElementById('accuracy').innerText = Math.floor((correctKeys / totalKeys) * 100);
            document.getElementById('score').innerText = score;
            document.getElementById('level-display').innerText = level;
            document.getElementById('combo-text').style.visibility = combo > 1 ? 'visible' : 'hidden';
            document.getElementById('combo-count').innerText = combo;
        });

        function nextWord() {
            const bank = wordBanks[Math.min(level, 5)];
            const pick = bank[Math.floor(Math.random() * bank.length)];
            document.getElementById('word-jp').innerText = pick.jp;
            currentRomaji = pick.r;
            document.getElementById('ghost-word').innerText = currentRomaji;
            charIndex = 0;
        }

        function endGame() {
            isPlaying = false;
            clearInterval(timerInterval);
            document.getElementById('word-jp').innerText = "FINISH!";
            let ranking = JSON.parse(localStorage.getItem('typingRanking')) || [];
            ranking.push(score);
            ranking.sort((a, b) => b - a);
            ranking = ranking.slice(0, 3);
            localStorage.setItem('typingRanking', JSON.stringify(ranking));
            document.getElementById('ranking-list').innerHTML = ranking.map((s, i) => `<div class="rank-item">${i+1}‰Ωç: ${s}ÁÇπ</div>`).join("");
            document.getElementById('ranking-container').style.display = "block";
        }

        loadWords();
    </script>
</body>
</html>
