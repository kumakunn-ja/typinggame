<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Typing Master JP</title>
    <style>
        :root { --main-color: #58a6ff; --bg-color: #0d1117; --danger-color: #ff4d4d; }
        body {
            background: var(--bg-color); color: #c9d1d9;
            font-family: 'Segoe UI', 'Meiryo', sans-serif;
            margin: 0; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; transition: background 0.15s;
        }
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 10; }
        .container { text-align: center; width: 100%; z-index: 5; }
        
        #word-jp { font-size: 4.5rem; margin: 0; color: var(--main-color); text-shadow: 0 0 15px rgba(88,166,255,0.4); }
        
        .typing-wrapper {
            position: relative; font-size: 3rem; height: 4rem;
            margin-top: 15px; letter-spacing: 4px; font-family: 'Consolas', 'Courier New', monospace;
        }
        #ghost-word { position: absolute; width: 100%; left: 0; color: #30363d; z-index: 1; }
        #display-romaji { position: absolute; width: 100%; left: 0; z-index: 2; }
        .typed { color: #3fb950; text-shadow: 0 0 10px rgba(63,185,80,0.6); }
        
        .stats { margin-top: 50px; font-size: 1.2rem; display: flex; justify-content: center; gap: 35px; opacity: 0.8; }
        .level-badge { color: #f1c40f; font-weight: bold; font-size: 1.5rem; margin-bottom: 10px; }
        
        #combo-text { font-size: 2.2rem; font-weight: bold; color: #f0883e; visibility: hidden; height: 45px; transition: transform 0.1s; }
        .mistake-flash { background: #4a0000 !important; }
        
        #ranking-container {
            margin-top: 25px; background: rgba(255, 255, 255, 0.07);
            padding: 20px; border-radius: 12px; display: none;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .rank-item { font-size: 1.3rem; color: #f1c40f; margin: 8px 0; }
        
        .shake { animation: shake 0.2s ease-in-out; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
    </style>
</head>
<body>
    <canvas id="particleCanvas"></canvas>

    <div class="container" id="game-body">
        <div id="combo-text">COMBO x<span id="combo-count">0</span></div>
        <div class="level-badge">LEVEL <span id="level-display">1</span></div>
        <h1 id="word-jp">LOADING...</h1>
        
        <div class="typing-wrapper">
            <div id="ghost-word"></div>
            <div id="display-romaji">Waiting for Data</div>
        </div>
        
        <div class="stats">
            <div>SCORE: <span id="score">0</span></div>
            <div>ACC: <span id="accuracy">100</span>%</div>
            <div>TIME: <span id="timer">20.0</span>s</div>
        </div>

        <div id="ranking-container">
            <h3 style="margin:0 0 15px 0;">üèÜ PERSONAL BESTS</h3>
            <div id="ranking-list"></div>
            <p style="font-size: 0.9rem; color: #888; margin-top:15px;">‰Ωï„Åã„Ç≠„Éº„ÇíÊäº„Åó„Å¶„É™„Éà„É©„Ç§</p>
        </div>
    </div>

    <script>
        // --- Ë®≠ÂÆö ---
        let wordBanks = {};
        let score = 0, timeLeft = 20, isPlaying = false;
        let currentRomaji = "", charIndex = 0, combo = 0;
        let totalKeys = 0, correctKeys = 0, level = 1, wordsTypedInLevel = 0;
        let timerInterval;

        const canvas = document.getElementById('particleCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // --- „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÁÆ°ÁêÜ ---
        let particles = [];
        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                this.size = Math.random() * 4 + 2;
                this.speedX = (Math.random() - 0.5) * 12;
                this.speedY = (Math.random() - 0.5) * 12;
                this.color = color;
                this.alpha = 1;
            }
            update() { this.x += this.speedX; this.y += this.speedY; this.alpha -= 0.025; }
            draw() {
                ctx.save();
                ctx.globalAlpha = this.alpha; ctx.fillStyle = this.color;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
                ctx.restore();
            }
        }

        function createParticles(color) {
            for (let i = 0; i < 25; i++) particles.push(new Particle(window.innerWidth / 2, window.innerHeight / 2, color));
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles = particles.filter(p => p.alpha > 0);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animate);
        }
        animate();

        // --- „Ç™„Éº„Éá„Ç£„Ç™ (BGM & ÂäπÊûúÈü≥) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playNote(freq, type, duration, vol) {
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.type = type; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
            g.gain.setValueAtTime(vol, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + duration);
        }

        function startBGM() {
            let melody = [261, 329, 392, 523]; // C-E-G-C
            let i = 0;
            const bgmInterval = setInterval(() => {
                if (!isPlaying) { clearInterval(bgmInterval); return; }
                playNote(melody[i % 4] * 0.5, 'triangle', 0.6, 0.02);
                i++;
            }, 600);
        }

        // --- „Ç≤„Éº„É†„É≠„Ç∏„ÉÉ„ÇØ ---
        async function loadWords() {
            try {
                const response = await fetch('words.json');
                wordBanks = await response.json();
                document.getElementById('word-jp').innerText = "READY?";
                document.getElementById('display-romaji').innerText = "Press Any Key to Start";
            } catch (e) {
                document.getElementById('word-jp').innerText = "DATA ERROR";
                console.error("words.json„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
            }
        }

        function nextWord() {
            const currentBank = wordBanks[Math.min(level, 10).toString()];
            if (!currentBank) return;
            const pick = currentBank[Math.floor(Math.random() * currentBank.length)];
            document.getElementById('word-jp').innerText = pick.jp;
            currentRomaji = pick.r;
            document.getElementById('ghost-word').innerText = currentRomaji;
            charIndex = 0;
            renderWord();
        }

        function renderWord() {
            document.getElementById('display-romaji').innerHTML = `<span class="typed">${currentRomaji.substring(0, charIndex)}</span>`;
        }

        window.addEventListener('keydown', (e) => {
            if (e.key === "Shift" || e.ctrlKey || e.altKey) return;

            // „É™„Éà„É©„Ç§Âá¶ÁêÜ
            if (!isPlaying && timeLeft <= 0) { location.reload(); return; }

            // ÈñãÂßãÂá¶ÁêÜ
            if (!isPlaying && Object.keys(wordBanks).length > 0) {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                isPlaying = true;
                startBGM();
                timerInterval = setInterval(() => {
                    timeLeft -= 0.1;
                    document.getElementById('timer').innerText = Math.max(0, timeLeft).toFixed(1);
                    if (timeLeft <= 0) endGame();
                }, 100);
                nextWord();
                return;
            }

            if (!isPlaying) return;

            totalKeys++;
            if (e.key === currentRomaji[charIndex]) {
                correctKeys++;
                charIndex++;
                playNote(400 + (combo * 15), 'sine', 0.1, 0.08);
                renderWord();

                // ÂçòË™û„ÇØ„É™„Ç¢
                if (charIndex === currentRomaji.length) {
                    combo++;
                    createParticles('#3fb950');
                    // „Çπ„Ç≥„Ç¢Ë®àÁÆó (ÊñáÂ≠óÊï∞ * „É¨„Éô„É´ * „Ç≥„É≥„Éú)
                    score += (currentRomaji.length * 10 * level * (1 + (combo * 0.1)));
                    
                    // „ÄêÈáçË¶Å„Äë„Çø„Ç§„É†„Éú„Éº„Éä„Çπ: ÊñáÂ≠óÊï∞ * 0.15Áßí + Âü∫Êú¨1Áßí
                    timeLeft += (currentRomaji.length * 0.15) + Math.max(0.2, 1.0 - (level * 0.1));
                    
                    wordsTypedInLevel++;
                    if (wordsTypedInLevel >= 5) {
                        level++;
                        wordsTypedInLevel = 0;
                        playNote(200, 'square', 0.4, 0.05); // „É¨„Éô„É´„Ç¢„ÉÉ„ÉóÈü≥
                    }
                    nextWord();
                }
            } else {
                // „Éü„Çπ
                combo = 0;
                document.getElementById('game-body').classList.add('shake');
                document.body.classList.add('mistake-flash');
                playNote(120, 'sawtooth', 0.2, 0.06);
                setTimeout(() => {
                    document.getElementById('game-body').classList.remove('shake');
                    document.body.classList.remove('mistake-flash');
                }, 150);
            }

            // „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
            document.getElementById('score').innerText = Math.floor(score);
            document.getElementById('accuracy').innerText = Math.floor((correctKeys / totalKeys) * 100);
            document.getElementById('level-display').innerText = level;
            document.getElementById('combo-text').style.visibility = combo > 1 ? 'visible' : 'hidden';
            document.getElementById('combo-count').innerText = combo;
        });

        function endGame() {
            isPlaying = false;
            clearInterval(timerInterval);
            document.getElementById('word-jp').innerText = "FINISH!";
            document.getElementById('ghost-word').innerText = "";
            document.getElementById('display-romaji').innerText = `TOTAL SCORE: ${Math.floor(score)}`;
            
            // „É©„É≥„Ç≠„É≥„Ç∞‰øùÂ≠ò
            let ranking = JSON.parse(localStorage.getItem('typingRanking')) || [];
            ranking.push(Math.floor(score));
            ranking.sort((a, b) => b - a);
            ranking = ranking.slice(0, 3);
            localStorage.setItem('typingRanking', JSON.stringify(ranking));
            
            document.getElementById('ranking-list').innerHTML = ranking.map((s, i) => `<div class="rank-item">${i+1}‰Ωç: ${s}ÁÇπ</div>`).join("");
            document.getElementById('ranking-container').style.display = "block";
            playNote(150, 'square', 0.6, 0.1);
        }

        loadWords();
    </script>
</body>
</html>
