<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Ultimate Typing: Accuracy & Effects</title>
    <style>
        :root { --main-color: #58a6ff; --bg-color: #0d1117; --danger-color: #ff4d4d; }
        body {
            background: var(--bg-color); color: #c9d1d9;
            font-family: 'Segoe UI', sans-serif;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; margin: 0; overflow: hidden;
            transition: background 0.2s; /* ËÉåÊôØËâ≤Â§âÂåñ„ÅÆ„Çπ„Éî„Éº„Éâ */
        }
        /* „Éü„ÇπÊôÇ„ÅÆ„Ç®„Éï„Çß„ÇØ„ÉàÁî®„ÇØ„É©„Çπ */
        body.mistake-flash { background: #4a0000; }

        .container { text-align: center; width: 100%; transition: transform 0.1s; }
        #word-jp { font-size: 5rem; margin: 0; color: var(--main-color); }
        .typing-wrapper {
            position: relative; font-size: 3.5rem; height: 4.5rem;
            margin-top: 10px; letter-spacing: 5px; font-family: 'Courier New', Courier, monospace;
        }
        #ghost-word { position: absolute; width: 100%; left: 0; color: #30363d; z-index: 1; }
        #display-romaji { position: absolute; width: 100%; left: 0; z-index: 2; }
        .typed { color: #3fb950; text-shadow: 0 0 10px rgba(63,185,80,0.5); }
        
        .stats { margin-top: 40px; font-size: 1.2rem; display: flex; justify-content: center; gap: 30px; }
        .accuracy-badge { color: #8b949e; }
        .level-badge { color: #f1c40f; font-weight: bold; }

        #ranking-container {
            margin-top: 20px; background: rgba(255, 255, 255, 0.05);
            padding: 15px; border-radius: 10px; display: none;
        }
        .rank-item { font-size: 1.2rem; margin: 5px 0; color: #f1c40f; }

        .shake { animation: shake 0.2s ease-in-out; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
    </style>
</head>
<body>

    <div class="container" id="game-body">
        <div id="combo-text" style="font-size: 2rem; font-weight: bold; color: #f0883e; visibility: hidden; height: 40px;">
            COMBO x<span id="combo-count">0</span>
        </div>
        
        <div class="level-badge">LEVEL <span id="level-display">1</span></div>
        <h1 id="word-jp">LOADING...</h1>
        
        <div class="typing-wrapper">
            <div id="ghost-word"></div>
            <div id="display-romaji">Wait...</div>
        </div>
        
        <div class="stats">
            <div>SCORE: <span id="score">0</span></div>
            <div>ACCURACY: <span id="accuracy">100</span>%</div>
            <div>TIME: <span id="timer">20</span>s</div>
        </div>

        <div id="ranking-container">
            <h3 style="margin:0 0 10px 0;">üèÜ PERSONAL BEST</h3>
            <div id="ranking-list"></div>
            <p style="font-size: 0.8rem; color: #888; margin-top:10px;">„Ç≠„Éº„ÇíÊäº„Åó„Å¶„É™„Éà„É©„Ç§</p>
        </div>
    </div>

    <script>
        let wordBanks = {};
        let score = 0, timeLeft = 20, isPlaying = false;
        let currentRomaji = "", charIndex = 0, combo = 0;
        let totalKeys = 0, correctKeys = 0; // Ê≠£Á¢∫ÁéáÁî®
        let level = 1, wordsTypedInLevel = 0;
        let timerInterval;

        const wordDisplayJP = document.getElementById('word-jp');
        const romajiDisplay = document.getElementById('display-romaji');
        const ghostDisplay = document.getElementById('ghost-word');
        const scoreDisplay = document.getElementById('score');
        const timerDisplay = document.getElementById('timer');
        const accuracyDisplay = document.getElementById('accuracy');
        const levelDisplay = document.getElementById('level-display');
        const comboText = document.getElementById('combo-text');
        const gameBody = document.getElementById('game-body');

        // „Éá„Éº„ÇøË™≠„ÅøËæº„Åø
        async function loadWords() {
            try {
                const response = await fetch('words.json');
                wordBanks = await response.json();
                wordDisplayJP.innerText = "READY?";
                romajiDisplay.innerText = "Press any key";
            } catch (e) {
                wordDisplayJP.innerText = "ERROR";
                console.error(e);
            }
        }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(f, t, d, v = 0.1) {
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
            g.gain.setValueAtTime(v, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + d);
        }

        function nextWord() {
            const bank = wordBanks[Math.min(level, 5)];
            const pick = bank[Math.floor(Math.random() * bank.length)];
            wordDisplayJP.innerText = pick.jp;
            currentRomaji = pick.r;
            ghostDisplay.innerText = currentRomaji;
            charIndex = 0;
            renderWord();
        }

        function renderWord() {
            romajiDisplay.innerHTML = `<span class="typed">${currentRomaji.substring(0, charIndex)}</span>`;
        }

        // --- „É©„É≥„Ç≠„É≥„Ç∞Âá¶ÁêÜ ---
        function updateRanking(finalScore) {
            let ranking = JSON.parse(localStorage.getItem('typingRanking')) || [];
            ranking.push(finalScore);
            ranking.sort((a, b) => b - a);
            ranking = ranking.slice(0, 3);
            localStorage.setItem('typingRanking', JSON.stringify(ranking));
            
            const list = document.getElementById('ranking-list');
            list.innerHTML = ranking.map((s, i) => `<div class="rank-item">${i+1}‰Ωç: ${s}ÁÇπ</div>`).join("");
            document.getElementById('ranking-container').style.display = "block";
        }

        window.addEventListener('keydown', (e) => {
            if (e.key === "Shift") return;

            // „Ç≤„Éº„É†„Çπ„Çø„Éº„Éà / „É™„Éà„É©„Ç§
            if (!isPlaying && timeLeft <= 0) { 
                location.reload(); // ÁµÇ‰∫ÜÂæå„ÅØ„É™„É≠„Éº„Éâ„Åß„É™„Çª„ÉÉ„Éà
                return;
            }
            if (!isPlaying && Object.keys(wordBanks).length > 0) {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                isPlaying = true;
                timerInterval = setInterval(updateTimer, 100); // 0.1ÁßíÂçò‰Ωç„ÅßÊõ¥Êñ∞
                nextWord();
                return;
            }

            if (!isPlaying) return;

            totalKeys++; // ÂÖ•Âäõ„Åó„ÅüÂêàË®à„Ç≠„ÉºÊï∞
            if (e.key === currentRomaji[charIndex]) {
                correctKeys++; // Ê≠£Ëß£Êï∞
                charIndex++;
                playSound(400 + (combo * 10), 'sine', 0.1);
                renderWord();

                if (charIndex === currentRomaji.length) {
                    combo++;
                    if (combo > 1) { 
                        comboText.style.visibility = 'visible'; 
                        document.getElementById('combo-count').innerText = combo; 
                    }
                    score += (10 * combo * level);
                    scoreDisplay.innerText = score;
                    timeLeft += Math.max(0.4, 1.5 - (level * 0.2)); 
                    wordsTypedInLevel++;
                    if (wordsTypedInLevel >= 5) {
                        level++; levelDisplay.innerText = level;
                        wordsTypedInLevel = 0;
                    }
                    playSound(800 + (combo * 20), 'sine', 0.2);
                    nextWord();
                }
            } else {
                // „Éü„ÇπÊôÇ„ÅÆ„Ç®„Éï„Çß„ÇØ„Éà
                combo = 0;
                comboText.style.visibility = 'hidden';
                gameBody.classList.add('shake');
                document.body.classList.add('mistake-flash'); // ËÉåÊôØ„ÇíËµ§„Åè
                setTimeout(() => {
                    gameBody.classList.remove('shake');
                    document.body.classList.remove('mistake-flash');
                }, 150);
                playSound(100, 'sawtooth', 0.2, 0.05);
            }

            // Ê≠£Á¢∫Áéá„ÅÆË®àÁÆó
            const acc = Math.floor((correctKeys / totalKeys) * 100);
            accuracyDisplay.innerText = acc;
        });

        function updateTimer() {
            timeLeft -= 0.1;
            timerDisplay.innerText = Math.max(0, timeLeft).toFixed(1);
            if (timeLeft <= 0) {
                isPlaying = false;
                clearInterval(timerInterval);
                wordDisplayJP.innerText = "FINISH!";
                ghostDisplay.innerText = "";
                romajiDisplay.innerText = `ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: ${score}`;
                updateRanking(score);
            }
        }

        loadWords();
    </script>
</body>
</html>
